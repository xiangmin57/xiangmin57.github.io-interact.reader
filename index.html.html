<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LireAventure - æ³•è¯­å­¦ä¹ å¹³å°</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .level-badge {
            background-color: var(--accent);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .tab-container {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--secondary);
            color: var(--secondary);
        }
        
        .tab.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .content-section {
            display: none;
            background: white;
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .content-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .story-title {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }
        
        .story-content {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 2rem;
            min-height: 200px;
        }
        
        .french-text {
            cursor: pointer;
        }
        
        .word-highlight {
            background-color: rgba(52, 152, 219, 0.2);
            padding: 0 2px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .word-highlight:hover {
            background-color: rgba(52, 152, 219, 0.4);
        }
        
        .word-clickable {
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .word-clickable:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .choices-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .choice-btn {
            padding: 1rem;
            background-color: var(--light);
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
        }
        
        .choice-btn:hover {
            background-color: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .choice-btn:hover .translation-btn {
            background-color: white;
            color: var(--secondary);
        }
        
        .choice-btn .translation-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: var(--secondary);
            padding: 0.3rem 0.6rem;
            border-radius: 3px;
            transition: all 0.3s;
        }
        
        .word-tooltip {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 0.8rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            z-index: 100;
            max-width: 300px;
            display: none;
        }
        
        .word-tooltip .word {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--primary);
        }
        
        .word-tooltip .definition {
            margin-bottom: 0.5rem;
        }
        
        .word-tooltip .pos {
            font-style: italic;
            color: #999;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }
        
        .pronunciation {
            color: var(--secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .add-to-vocab {
            margin-top: 0.5rem;
            padding: 0.3rem 0.5rem;
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .progress-bar {
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.5s;
        }
        
        .vocab-list {
            margin-top: 2rem;
        }
        
        .vocab-item {
            padding: 0.8rem;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .vocab-word {
            font-weight: bold;
        }
        
        .theme-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .theme-btn {
            padding: 0.8rem 1.5rem;
            background-color: var(--light);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .theme-btn.active {
            background-color: var(--secondary);
            color: white;
        }
        
        .story-controls {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary {
            background-color: var(--light);
            color: var(--dark);
        }
        
        .language-help {
            background-color: #fff9e6;
            border-left: 4px solid #ffcc00;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 4px;
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .audio-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--secondary);
        }
        
        .translation-container {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 5px;
            color: #333;
        }
        
        .choice-translation {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #f0f8ff;
            border-radius: 3px;
            font-size: 0.9rem;
            color: #333;
        }
        
        .scene-image {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .theme-selection {
            text-align: center;
            padding: 2rem;
        }
        
        .theme-option {
            display: inline-block;
            width: 30%;
            margin: 1%;
            padding: 2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            vertical-align: top;
            min-height: 200px;
        }
        
        .theme-option.sci-fi {
            background-color: #e1f5fe;
            border: 2px solid #01579b;
        }
        
        .theme-option.romance {
            background-color: #fce4ec;
            border: 2px solid #880e4f;
        }
        
        .theme-option.thriller {
            background-color: #fff3e0;
            border: 2px solid #e65100;
        }
        
        .theme-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .theme-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .theme-description {
            margin-bottom: 1rem;
        }
        
        .completion-btn {
            margin-top: 2rem;
            padding: 1rem 2rem;
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: bold;
        }
        
        .audio-playing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .audio-wave {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .audio-bar {
            width: 3px;
            height: 15px;
            background-color: var(--secondary);
            animation: audioWave 1s infinite ease-in-out;
        }
        
        .audio-bar:nth-child(2) {
            animation-delay: 0.1s;
        }
        
        .audio-bar:nth-child(3) {
            animation-delay: 0.2s;
        }
        
        .audio-bar:nth-child(4) {
            animation-delay: 0.3s;
        }
        
        .audio-bar:nth-child(5) {
            animation-delay: 0.4s;
        }
        
        @keyframes audioWave {
            0%, 100% {
                height: 5px;
            }
            50% {
                height: 15px;
            }
        }
        
        @media (max-width: 768px) {
            .choices-container {
                grid-template-columns: 1fr;
            }
            
            .theme-selector {
                flex-direction: column;
            }
            
            .theme-option {
                width: 100%;
                margin: 1rem 0;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">LireAventure</div>
        <div class="user-info">
            <span>ç”¨æˆ·: Pierre</span>
            <div class="level-badge">æ°´å¹³ A1</div>
        </div>
    </header>
    
    <div class="container">
        <div class="tab-container">
            <div class="tab active" data-tab="theme">é€‰æ‹©ä¸»é¢˜</div>
            <div class="tab disabled" data-tab="story" id="story-tab">äº’åŠ¨æ•…äº‹</div>
            <div class="tab" data-tab="vocab-book">ç”Ÿè¯æœ¬</div>
        </div>
        
        <div class="content-section active" id="theme-section">
            <h2 class="story-title">é€‰æ‹©æ‚¨çš„æ•…äº‹ä¸»é¢˜</h2>
            
            <div class="language-help">
                <strong>æç¤ºï¼š</strong> é€‰æ‹©ä¸€ä¸ªæ‚¨æ„Ÿå…´è¶£çš„ä¸»é¢˜ï¼Œæˆ‘ä»¬å°†æ ¹æ®æ‚¨çš„é€‰æ‹©ç”Ÿæˆä¸ªæ€§åŒ–çš„æ•…äº‹ã€‚
            </div>
            
            <div class="theme-selection">
                <div class="theme-option sci-fi" data-theme="sci-fi">
                    <div class="theme-title">ğŸš€ ç§‘å¹»å†’é™©</div>
                    <div class="theme-description">æ¢ç´¢æœªçŸ¥çš„å®‡å®™ï¼Œé¢å¯¹å¤–æ˜Ÿæ–‡æ˜å’Œé«˜ç§‘æŠ€è°œå›¢ã€‚</div>
                    <p>é€‚åˆå–œæ¬¢ç§‘å­¦ã€æŠ€æœ¯å’Œæœªæ¥ä¸–ç•Œçš„å­¦ä¹ è€…</p>
                </div>
                
                <div class="theme-option romance" data-theme="romance">
                    <div class="theme-title">ğŸ’– æµªæ¼«çˆ±æƒ…</div>
                    <div class="theme-description">åœ¨å·´é»çš„æµªæ¼«è¡—å¤´ï¼Œé‚‚é€…å‘½è¿ä¸­çš„é‚£ä¸ªäººã€‚</div>
                    <p>é€‚åˆå–œæ¬¢æƒ…æ„Ÿæ•…äº‹å’Œäººé™…äº’åŠ¨çš„å­¦ä¹ è€…</p>
                </div>
                
                <div class="theme-option thriller" data-theme="thriller">
                    <div class="theme-title">ğŸ”ª æƒŠæ‚šæ‚¬ç–‘</div>
                    <div class="theme-description">è§£å¼€å¤è€åŸå ¡ä¸­çš„ç§˜å¯†ï¼Œé¢å¯¹æœªçŸ¥çš„å±é™©ã€‚</div>
                    <p>é€‚åˆå–œæ¬¢ç´§å¼ åˆºæ¿€å’Œæ¨ç†çš„å­¦ä¹ è€…</p>
                </div>
            </div>
        </div>
        
        <div class="content-section" id="story-section">
            <h2 class="story-title" id="story-title">å¤ªç©ºèˆ¹ä¹‹è°œ</h2>
            
            <img src="https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80" alt="å¤ªç©ºèˆ¹å†…éƒ¨" class="scene-image" id="story-image">
            
            <div class="audio-controls">
                <button class="btn btn-primary" id="story-play-toggle-btn">
                    <span class="audio-playing" id="audio-playing-indicator" style="display: none;">
                        <span class="audio-wave">
                            <span class="audio-bar"></span>
                            <span class="audio-bar"></span>
                            <span class="audio-bar"></span>
                            <span class="audio-bar"></span>
                            <span class="audio-bar"></span>
                        </span>
                        æ’­æ”¾ä¸­
                    </span>
                    <span id="replay-text">ğŸ”Š æ’­æ”¾éŸ³é¢‘</span>
                </button>
                <button class="btn btn-secondary" id="show-translation-btn">æ˜¾ç¤ºä¸­æ–‡ç¿»è¯‘</button>
            </div>
            
            <div class="progress-bar">
                <div class="progress" id="story-progress" style="width: 0%"></div>
            </div>
            <div style="margin-bottom: 1rem;">æ•…äº‹è¿›åº¦: <span id="story-progress-text">0%</span></div>
            
            <div class="language-help">
                <strong>æç¤ºï¼š</strong> ç‚¹å‡»ä»»ä½•æ³•è¯­å•è¯å¯ä»¥æŸ¥çœ‹ä¸­æ–‡é‡Šä¹‰å’Œå‘éŸ³ã€‚è“è‰²é«˜äº®å•è¯æ˜¯é‡ç‚¹è¯æ±‡ã€‚
            </div>
            
            <div class="story-content french-text" id="story-text">
                Vous Ãªtes un jeune scientifique Ã  bord du vaisseau spatial "Ã‰toile du Nord". Soudain, les lumiÃ¨res s'Ã©teignent et une alarme retentit. Le capitaine annonce : "Nous avons un problÃ¨me avec le systÃ¨me d'Ã©nergie principal. Nous devons agir vite !"
                
                Que faites-vous ?
            </div>
            
            <div class="translation-container" id="story-translation" style="display: none;">
                <strong>ä¸­æ–‡ç¿»è¯‘ï¼š</strong><br>
                æ‚¨æ˜¯ä¸€åå¹´è½»çš„ç§‘å­¦å®¶ï¼Œåœ¨"åŒ—æ–¹ä¹‹æ˜Ÿ"å¤ªç©ºèˆ¹ä¸Šã€‚çªç„¶ï¼Œç¯å…‰ç†„ç­ï¼Œè­¦æŠ¥å“èµ·ã€‚èˆ¹é•¿å®£å¸ƒï¼š"æˆ‘ä»¬çš„ä¸»èƒ½æºç³»ç»Ÿå‡ºäº†é—®é¢˜ã€‚æˆ‘ä»¬å¿…é¡»è¿…é€Ÿè¡ŒåŠ¨ï¼"
                æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ
            </div>
            
            <div class="choices-container" id="choices-container">
                <div class="choice-btn" data-next="1">
                    Je vais Ã  la salle des machines pour inspecter le problÃ¨me.
                    <button class="translation-btn">ç¿»è¯‘</button>
                    <div class="choice-translation" style="display: none;">æˆ‘å»æœºå™¨å®¤æ£€æŸ¥é—®é¢˜ã€‚</div>
                </div>
                <div class="choice-btn" data-next="2">
                    Je reste sur le pont et j'essaie de comprendre les donnÃ©es sur l'Ã©cran.
                    <button class="translation-btn">ç¿»è¯‘</button>
                    <div class="choice-translation" style="display: none;">æˆ‘ç•™åœ¨ç”²æ¿ä¸Šï¼Œè¯•ç€ç†è§£å±å¹•ä¸Šçš„æ•°æ®ã€‚</div>
                </div>
            </div>
            
            <div class="story-controls">
                <button class="btn btn-secondary" id="prev-story-btn">ä¸Šä¸€é¡µ</button>
                <button class="btn btn-secondary" id="restart-btn">é‡æ–°å¼€å§‹æ•…äº‹</button>
                <button class="btn btn-primary" id="save-btn">ä¿å­˜è¿›åº¦</button>
                <button class="completion-btn" id="complete-story-btn" style="display: none;">å®Œæˆæ•…äº‹</button>
            </div>
        </div>
        
        <div class="content-section" id="vocab-book-section">
            <h2>æˆ‘çš„ç”Ÿè¯æœ¬</h2>
            
            <div class="language-help">
                <strong>æç¤ºï¼š</strong> æ‚¨å¯ä»¥åœ¨é˜…è¯»è¿‡ç¨‹ä¸­ç‚¹å‡»å•è¯ï¼Œç„¶åç‚¹å‡»"æ·»åŠ åˆ°ç”Ÿè¯æœ¬"æ¥ä¿å­˜å•è¯ã€‚
            </div>
            
            <div class="vocab-list" id="vocab-book-list">
                <!-- ç”Ÿè¯æœ¬å†…å®¹å°†åŠ¨æ€ç”Ÿæˆ -->
                <div class="vocab-item">
                    <div>ç”Ÿè¯æœ¬ä¸ºç©ºï¼Œè¯·åœ¨é˜…è¯»è¿‡ç¨‹ä¸­æ·»åŠ å•è¯ã€‚</div>
                </div>
            </div>
            
            <div class="story-controls">
                <button class="btn btn-primary" id="practice-vocab">ç»ƒä¹ ç”Ÿè¯</button>
                <button class="btn btn-secondary" id="export-vocab">å¯¼å‡ºç”Ÿè¯æœ¬</button>
                <button class="btn btn-secondary" id="clear-vocab">æ¸…ç©ºç”Ÿè¯æœ¬</button>
            </div>
        </div>
    </div>
    
    <div class="word-tooltip" id="word-tooltip">
        <div class="word" id="tooltip-word"></div>
        <div class="pos" id="tooltip-pos"></div>
        <div class="definition" id="tooltip-definition"></div>
        <div class="pronunciation" id="tooltip-pronunciation">
            <span>ğŸ”Š</span>
            <span id="pronunciation-text"></span>
        </div>
        <button class="add-to-vocab" id="add-to-vocab-btn">æ·»åŠ åˆ°ç”Ÿè¯æœ¬</button>
    </div>

    <script>
        // é‡ç‚¹è¯æ±‡ - åªé«˜äº®æ˜¾ç¤ºè¿™äº›è¯æ±‡
        const highlightedWords = [
            "vaisseau", "lumiÃ¨res", "alarme", "capitaine", "problÃ¨me", "Ã©nergie", 
            "salle", "machines", "pont", "donnÃ©es", "Ã©cran", "planÃ¨te", "Ã©quipage",
            "hibernation", "alerte", "incomprÃ©hensibles", "inquiÃ¨te", "examinait",
            "fonctionner", "s'Ã©teignirent", "clignotaient", "inquiÃ©tante", "sombre",
            "bruit", "gÃ©nÃ©rateur", "analysez", "anomalie", "navigation", "cap",
            "autorisation", "artiste", "mystÃ©rieuse", "chÃ¢teau", "sous-sol", "bruits",
            "Ã©tranges", "lampe", "torche", "police", "suspects", "porte", "verrouillÃ©e",
            "clÃ©", "journal", "histoire"
        ];

        // å®Œæ•´è¯å…¸ - åŒ…å«æ‰€æœ‰ä¸»é¢˜çš„æ‰€æœ‰å•è¯
        const frenchDictionary = {
            // ç§‘å¹»ä¸»é¢˜è¯æ±‡
            "vaisseau": { definition: "å¤ªç©ºèˆ¹", pronunciation: "vÃ¨-so", pos: "åè¯" },
            "lumiÃ¨res": { definition: "ç¯å…‰", pronunciation: "lu-miÃ¨r", pos: "åè¯" },
            "alarme": { definition: "è­¦æŠ¥", pronunciation: "a-larm", pos: "åè¯" },
            "capitaine": { definition: "èˆ¹é•¿", pronunciation: "ka-pi-tÃ¨n", pos: "åè¯" },
            "problÃ¨me": { definition: "é—®é¢˜", pronunciation: "pro-blÃ¨m", pos: "åè¯" },
            "Ã©nergie": { definition: "èƒ½æº", pronunciation: "Ã©-nÃ¨r-ji", pos: "åè¯" },
            "salle": { definition: "æˆ¿é—´", pronunciation: "sal", pos: "åè¯" },
            "machines": { definition: "æœºå™¨", pronunciation: "ma-chin", pos: "åè¯" },
            "pont": { definition: "ç”²æ¿", pronunciation: "pon", pos: "åè¯" },
            "donnÃ©es": { definition: "æ•°æ®", pronunciation: "do-nÃ©", pos: "åè¯" },
            "Ã©cran": { definition: "å±å¹•", pronunciation: "Ã©-cran", pos: "åè¯" },
            "planÃ¨te": { definition: "è¡Œæ˜Ÿ", pronunciation: "pla-nÃ¨t", pos: "åè¯" },
            "Ã©quipage": { definition: "èˆ¹å‘˜", pronunciation: "Ã©-ki-paj", pos: "åè¯" },
            "hibernation": { definition: "å†¬çœ ", pronunciation: "i-bÃ¨r-na-sion", pos: "åè¯" },
            "alerte": { definition: "è­¦æŠ¥", pronunciation: "a-lÃ¨rte", pos: "åè¯" },
            "incomprÃ©hensibles": { definition: "éš¾ä»¥ç†è§£çš„", pronunciation: "in-com-prÃ©-an-sibl", pos: "å½¢å®¹è¯" },
            "inquiÃ¨te": { definition: "æ‹…å¿ƒçš„", pronunciation: "in-kiÃ¨t", pos: "å½¢å®¹è¯" },
            "examinait": { definition: "æ£€æŸ¥", pronunciation: "Ã¨g-za-mi-nÃ¨", pos: "åŠ¨è¯" },
            "fonctionner": { definition: "è¿è¡Œ", pronunciation: "fonk-sio-nÃ©", pos: "åŠ¨è¯" },
            "s'Ã©teignirent": { definition: "ç†„ç­", pronunciation: "sÃ©-tÃ¨-gnire", pos: "åŠ¨è¯" },
            "clignotaient": { definition: "é—ªçƒ", pronunciation: "kli-gno-tÃ¨", pos: "åŠ¨è¯" },
            "inquiÃ©tante": { definition: "ä»¤äººä¸å®‰çš„", pronunciation: "in-kiÃ©-tante", pos: "å½¢å®¹è¯" },
            "sombre": { definition: "é»‘æš—çš„", pronunciation: "som-br", pos: "å½¢å®¹è¯" },
            "bruit": { definition: "å£°éŸ³", pronunciation: "brui", pos: "åè¯" },
            "gÃ©nÃ©rateur": { definition: "å‘ç”µæœº", pronunciation: "jÃ©-nÃ©-ra-teur", pos: "åè¯" },
            "analysez": { definition: "åˆ†æ", pronunciation: "a-na-li-zÃ©", pos: "åŠ¨è¯" },
            "anomalie": { definition: "å¼‚å¸¸", pronunciation: "a-no-ma-li", pos: "åè¯" },
            "navigation": { definition: "å¯¼èˆª", pronunciation: "na-vi-ga-sion", pos: "åè¯" },
            "cap": { definition: "èˆªå‘", pronunciation: "kap", pos: "åè¯" },
            "autorisation": { definition: "æˆæƒ", pronunciation: "o-to-ri-za-sion", pos: "åè¯" },
            
            // æµªæ¼«ä¸»é¢˜è¯æ±‡
            "artiste": { definition: "è‰ºæœ¯å®¶", pronunciation: "ar-tist", pos: "åè¯" },
            "mystÃ©rieuse": { definition: "ç¥ç§˜çš„", pronunciation: "mis-tÃ©-rieuz", pos: "å½¢å®¹è¯" },
            "peignant": { definition: "ç»˜ç”»", pronunciation: "pe-gnan", pos: "åŠ¨è¯" },
            "rencontrez": { definition: "é‡è§", pronunciation: "ran-con-trÃ©", pos: "åŠ¨è¯" },
            "personne": { definition: "äºº", pronunciation: "pÃ¨r-son", pos: "åè¯" },
            "change": { definition: "æ”¹å˜", pronunciation: "chanj", pos: "åŠ¨è¯" },
            "vie": { definition: "ç”Ÿæ´»", pronunciation: "vi", pos: "åè¯" },
            "tableau": { definition: "ç”»ä½œ", pronunciation: "ta-blo", pos: "åè¯" },
            "invite": { definition: "é‚€è¯·", pronunciation: "in-vit", pos: "åŠ¨è¯" },
            "cafÃ©": { definition: "å’–å•¡", pronunciation: "ka-fÃ©", pos: "åè¯" },
            "parisien": { definition: "å·´é»çš„", pronunciation: "pa-ri-zyan", pos: "å½¢å®¹è¯" },
            "musicienne": { definition: "éŸ³ä¹å®¶", pronunciation: "mu-zi-syÃ¨n", pos: "åè¯" },
            "piano": { definition: "é’¢ç´", pronunciation: "pya-no", pos: "åè¯" },
            "passion": { definition: "çƒ­æƒ…", pronunciation: "pa-syon", pos: "åè¯" },
            "art": { definition: "è‰ºæœ¯", pronunciation: "ar", pos: "åè¯" },
            "offre": { definition: "æä¾›", pronunciation: "o-fr", pos: "åŠ¨è¯" },
            "apprendre": { definition: "å­¦ä¹ ", pronunciation: "a-prandr", pos: "åŠ¨è¯" },
            
            // æƒŠæ‚šä¸»é¢˜è¯æ±‡
            "chÃ¢teau": { definition: "åŸå ¡", pronunciation: "sha-to", pos: "åè¯" },
            "sous-sol": { definition: "åœ°ä¸‹å®¤", pronunciation: "su-sol", pos: "åè¯" },
            "bruits": { definition: "å£°éŸ³", pronunciation: "brui", pos: "åè¯" },
            "Ã©tranges": { definition: "å¥‡æ€ªçš„", pronunciation: "Ã©-tranj", pos: "å½¢å®¹è¯" },
            "lampe": { definition: "ç¯", pronunciation: "lamp", pos: "åè¯" },
            "torche": { definition: "æ‰‹ç”µç­’", pronunciation: "torch", pos: "åè¯" },
            "police": { definition: "è­¦å¯Ÿ", pronunciation: "po-lis", pos: "åè¯" },
            "suspects": { definition: "å¯ç–‘çš„", pronunciation: "sus-pÃ¨", pos: "å½¢å®¹è¯" },
            "porte": { definition: "é—¨", pronunciation: "port", pos: "åè¯" },
            "verrouillÃ©e": { definition: "é”ç€çš„", pronunciation: "vÃ¨-ru-yÃ©", pos: "å½¢å®¹è¯" },
            "clÃ©": { definition: "é’¥åŒ™", pronunciation: "klÃ©", pos: "åè¯" },
            "journal": { definition: "æ—¥è®°", pronunciation: "jour-nal", pos: "åè¯" },
            "histoire": { definition: "å†å²", pronunciation: "is-twar", pos: "åè¯" },
            
            // åŸºç¡€è¯æ±‡
            "vous": { definition: "æ‚¨", pronunciation: "vu", pos: "ä»£è¯" },
            "Ãªtes": { definition: "æ˜¯", pronunciation: "Ã¨t", pos: "åŠ¨è¯" },
            "un": { definition: "ä¸€ä¸ª", pronunciation: "un", pos: "å† è¯" },
            "jeune": { definition: "å¹´è½»çš„", pronunciation: "jeune", pos: "å½¢å®¹è¯" },
            "scientifique": { definition: "ç§‘å­¦å®¶", pronunciation: "syan-ti-fik", pos: "åè¯" },
            "Ã ": { definition: "åœ¨", pronunciation: "a", pos: "ä»‹è¯" },
            "bord": { definition: "èˆ¹ä¸Š", pronunciation: "bor", pos: "åè¯" },
            "du": { definition: "çš„", pronunciation: "dy", pos: "å† è¯" },
            "spatial": { definition: "å¤ªç©ºçš„", pronunciation: "spa-syal", pos: "å½¢å®¹è¯" },
            "Ã©toile": { definition: "æ˜Ÿæ˜Ÿ", pronunciation: "e-twal", pos: "åè¯" },
            "nord": { definition: "åŒ—æ–¹", pronunciation: "nor", pos: "åè¯" },
            "soudain": { definition: "çªç„¶", pronunciation: "su-dan", pos: "å‰¯è¯" },
            "les": { definition: "å®šå† è¯", pronunciation: "le", pos: "å† è¯" },
            "s'Ã©teignent": { definition: "ç†„ç­", pronunciation: "se-tegn", pos: "åŠ¨è¯" },
            "et": { definition: "å’Œ", pronunciation: "e", pos: "è¿è¯" },
            "une": { definition: "ä¸€ä¸ª", pronunciation: "yn", pos: "å† è¯" },
            "retentit": { definition: "å“èµ·", pronunciation: "re-tan-ti", pos: "åŠ¨è¯" },
            "annonce": { definition: "å®£å¸ƒ", pronunciation: "a-nons", pos: "åŠ¨è¯" },
            "nous": { definition: "æˆ‘ä»¬", pronunciation: "nu", pos: "ä»£è¯" },
            "avons": { definition: "æœ‰", pronunciation: "a-von", pos: "åŠ¨è¯" },
            "avec": { definition: "ä¸", pronunciation: "a-vek", pos: "ä»‹è¯" },
            "le": { definition: "å®šå† è¯", pronunciation: "le", pos: "å† è¯" },
            "systÃ¨me": { definition: "ç³»ç»Ÿ", pronunciation: "sis-tem", pos: "åè¯" },
            "d'": { definition: "çš„", pronunciation: "d", pos: "ä»‹è¯" },
            "principal": { definition: "ä¸»è¦çš„", pronunciation: "pran-si-pal", pos: "å½¢å®¹è¯" },
            "devons": { definition: "å¿…é¡»", pronunciation: "de-von", pos: "åŠ¨è¯" },
            "agir": { definition: "è¡ŒåŠ¨", pronunciation: "a-zir", pos: "åŠ¨è¯" },
            "vite": { definition: "å¿«é€Ÿ", pronunciation: "vit", pos: "å‰¯è¯" },
            "que": { definition: "ä»€ä¹ˆ", pronunciation: "ke", pos: "ä»£è¯" },
            "faites-vous": { definition: "æ‚¨åšä»€ä¹ˆ", pronunciation: "fet-vu", pos: "åŠ¨è¯çŸ­è¯­" },
            "je": { definition: "æˆ‘", pronunciation: "re", pos: "ä»£è¯" },
            "vais": { definition: "å»", pronunciation: "vÃ¨", pos: "åŠ¨è¯" },
            "la": { definition: "å®šå† è¯", pronunciation: "la", pos: "å† è¯" },
            "des": { definition: "çš„", pronunciation: "dÃ¨", pos: "å† è¯" },
            "pour": { definition: "ä¸ºäº†", pronunciation: "pur", pos: "ä»‹è¯" },
            "inspecter": { definition: "æ£€æŸ¥", pronunciation: "in-spÃ¨k-tÃ©", pos: "åŠ¨è¯" },
            "reste": { definition: "åœç•™", pronunciation: "rÃ¨st", pos: "åŠ¨è¯" },
            "sur": { definition: "åœ¨...ä¸Š", pronunciation: "sur", pos: "ä»‹è¯" },
            "j'essaie": { definition: "æˆ‘å°è¯•", pronunciation: "jÃ©-sÃ¨", pos: "åŠ¨è¯" },
            "de": { definition: "çš„", pronunciation: "de", pos: "ä»‹è¯" },
            "comprendre": { definition: "ç†è§£", pronunciation: "com-prandr", pos: "åŠ¨è¯" },
            "l'": { definition: "å®šå† è¯", pronunciation: "l", pos: "å† è¯" }
        };

        // ç”Ÿè¯æœ¬æ•°æ® - åˆå§‹ä¸ºç©º
        let vocabBook = JSON.parse(localStorage.getItem('vocabBook')) || [];

        // æ•…äº‹çŠ¶æ€ç®¡ç†
        let storyHistory = [];
        let currentTheme = null;
        let currentPage = 0;
        let totalPages = 3; // å‡è®¾æ•…äº‹æœ‰3é¡µ
        
        // éŸ³é¢‘çŠ¶æ€ç®¡ç†
        let isPlaying = false;
        let currentUtterance = null;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // ç¡®ä¿ç”Ÿè¯æœ¬ä¸ºç©º
            if (vocabBook.length > 0 && vocabBook[0].word === "vous") {
                vocabBook = [];
                localStorage.setItem('vocabBook', JSON.stringify(vocabBook));
            }
            
            updateVocabBookDisplay();
        });
        
        // é€‰é¡¹å¡ç®¡ç†
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.classList.contains('disabled')) return;
                
                // ç§»é™¤æ‰€æœ‰é€‰é¡¹å¡å’Œå†…å®¹åŒºçš„activeç±»
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                
                // ä¸ºå½“å‰ç‚¹å‡»çš„é€‰é¡¹å¡æ·»åŠ activeç±»
                tab.classList.add('active');
                
                // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒº
                const tabId = tab.getAttribute('data-tab');
                document.getElementById(`${tabId}-section`).classList.add('active');
                
                // å¦‚æœæ˜¯ç”Ÿè¯æœ¬é¡µé¢ï¼Œæ›´æ–°æ˜¾ç¤º
                if (tabId === 'vocab-book') {
                    updateVocabBookDisplay();
                }
                
                // å¦‚æœæ˜¯æ•…äº‹é¡µé¢ï¼Œæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®ä½†ä¸è‡ªåŠ¨æ’­æ”¾
                if (tabId === 'story' && currentTheme) {
                    // ä¸è‡ªåŠ¨æ’­æ”¾ï¼Œåªæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
                    document.getElementById('audio-playing-indicator').style.display = 'none';
                    document.getElementById('replay-text').style.display = 'inline';
                    document.getElementById('replay-text').textContent = 'ğŸ”Š æ’­æ”¾éŸ³é¢‘';
                }
            });
        });
        
        // ä¸»é¢˜é€‰æ‹©
        document.querySelectorAll('.theme-option').forEach(option => {
            option.addEventListener('click', () => {
                currentTheme = option.getAttribute('data-theme');
                
                // å¯ç”¨æ•…äº‹é€‰é¡¹å¡
                document.getElementById('story-tab').classList.remove('disabled');
                
                // éšè—ä¸»é¢˜é€‰æ‹©é¡µé¢ï¼Œæ˜¾ç¤ºæ•…äº‹é¡µé¢
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                
                document.getElementById('story-tab').classList.add('active');
                document.getElementById('story-section').classList.add('active');
                
                // é‡ç½®æ•…äº‹å†å²
                storyHistory = [];
                currentPage = 0;
                
                // æ ¹æ®ä¸»é¢˜æ›´æ–°æ•…äº‹å†…å®¹
                updateStoryByTheme(currentTheme);
                
                // ä¸è‡ªåŠ¨æ’­æ”¾ï¼Œåªæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
                document.getElementById('audio-playing-indicator').style.display = 'none';
                document.getElementById('replay-text').style.display = 'inline';
                document.getElementById('replay-text').textContent = 'ğŸ”Š æ’­æ”¾éŸ³é¢‘';
            });
        });
        
        // æ ¹æ®ä¸»é¢˜æ›´æ–°æ•…äº‹å†…å®¹
        function updateStoryByTheme(theme) {
            let storyTitle, storyContent, storyImage, choices;
            
            switch(theme) {
                case 'sci-fi':
                    storyTitle = "å¤ªç©ºèˆ¹ä¹‹è°œ";
                    storyContent = "Vous Ãªtes un jeune scientifique Ã  bord du vaisseau spatial 'Ã‰toile du Nord'. Soudain, les lumiÃ¨res s'Ã©teignent et une alarme retentit. Le capitaine annonce : 'Nous avons un problÃ¨me avec le systÃ¨me d'Ã©nergie principal. Nous devons agir vite !' Que faites-vous ?";
                    storyImage = "https://images.unsplash.com/photo-1446776653964-20c1d3a81b06?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    choices = [
                        "Je vais Ã  la salle des machines pour inspecter le problÃ¨me.",
                        "Je reste sur le pont et j'essaie de comprendre les donnÃ©es sur l'Ã©cran."
                    ];
                    break;
                case 'romance':
                    storyTitle = "å·´é»é‚‚é€…";
                    storyContent = "Vous Ãªtes un artiste franÃ§ais vivant Ã  Paris. Un jour, en peignant prÃ¨s de la Seine, vous rencontrez une personne mystÃ©rieuse qui change votre vie. Que faites-vous ?";
                    storyImage = "https://images.unsplash.com/photo-1502602898657-3e91760cbb34?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    choices = [
                        "Je lui demande de poser pour mon tableau.",
                        "Je l'invite Ã  prendre un cafÃ© dans un petit cafÃ© parisien."
                    ];
                    break;
                case 'thriller':
                    storyTitle = "å¤å ¡ç§˜å¯†";
                    storyContent = "Vous hÃ©ritez d'un vieux chÃ¢teau en Provence. La premiÃ¨re nuit, vous entendez des bruits Ã©tranges provenant du sous-sol. Que faites-vous ?";
                    storyImage = "https://images.unsplash.com/photo-1578683010236-d716f9a3f461?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    choices = [
                        "J'explore le sous-sol avec une lampe torche.",
                        "J'appelle la police pour signaler les bruits suspects."
                    ];
                    break;
            }
            
            document.getElementById('story-title').textContent = storyTitle;
            document.getElementById('story-text').textContent = storyContent;
            document.getElementById('story-image').src = storyImage;
            
            // æ›´æ–°ç¿»è¯‘
            document.getElementById('story-translation').innerHTML = `
                <strong>ä¸­æ–‡ç¿»è¯‘ï¼š</strong><br>
                ${getStoryTranslation(storyContent, theme)}
            `;
            
            // æ›´æ–°é€‰é¡¹
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = '';
            
            choices.forEach((choice, index) => {
                const choiceBtn = document.createElement('div');
                choiceBtn.className = 'choice-btn';
                choiceBtn.setAttribute('data-next', index + 1);
                choiceBtn.innerHTML = `
                    ${choice}
                    <button class="translation-btn">ç¿»è¯‘</button>
                    <div class="choice-translation" style="display: none;">${getChoiceTranslation(choice, theme)}</div>
                `;
                choicesContainer.appendChild(choiceBtn);
            });
            
            // é‡ç½®è¿›åº¦
            updateStoryProgress(0);
            
            // é‡æ–°é™„åŠ äº‹ä»¶
            attachChoiceEvents();
            setupWordClickEvents();
            
            // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²
            storyHistory.push({
                theme: theme,
                step: 0,
                title: storyTitle,
                content: storyContent,
                image: storyImage,
                choices: choices
            });
        }
        
        // è·å–æ•…äº‹ç¿»è¯‘
        function getStoryTranslation(content, theme) {
            const translations = {
                'sci-fi': {
                    "Vous Ãªtes un jeune scientifique Ã  bord du vaisseau spatial 'Ã‰toile du Nord'. Soudain, les lumiÃ¨res s'Ã©teignent et une alarme retentit. Le capitaine annonce : 'Nous avons un problÃ¨me avec le systÃ¨me d'Ã©nergie principal. Nous devons agir vite !' Que faites-vous ?": 
                    "æ‚¨æ˜¯ä¸€åå¹´è½»çš„ç§‘å­¦å®¶ï¼Œåœ¨'åŒ—æ–¹ä¹‹æ˜Ÿ'å¤ªç©ºèˆ¹ä¸Šã€‚çªç„¶ï¼Œç¯å…‰ç†„ç­ï¼Œè­¦æŠ¥å“èµ·ã€‚èˆ¹é•¿å®£å¸ƒï¼š'æˆ‘ä»¬çš„ä¸»èƒ½æºç³»ç»Ÿå‡ºäº†é—®é¢˜ã€‚æˆ‘ä»¬å¿…é¡»è¿…é€Ÿè¡ŒåŠ¨ï¼' æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ"
                },
                'romance': {
                    "Vous Ãªtes un artiste franÃ§ais vivant Ã  Paris. Un jour, en peignant prÃ¨s de la Seine, vous rencontrez une personne mystÃ©rieuse qui change votre vie. Que faites-vous ?": 
                    "æ‚¨æ˜¯ä¸€åç”Ÿæ´»åœ¨å·´é»çš„æ³•å›½è‰ºæœ¯å®¶ã€‚ä¸€å¤©ï¼Œåœ¨å¡çº³æ²³é™„è¿‘ç”»ç”»æ—¶ï¼Œæ‚¨é‡åˆ°äº†ä¸€ä½æ”¹å˜æ‚¨ç”Ÿæ´»çš„ç¥ç§˜äººç‰©ã€‚æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ"
                },
                'thriller': {
                    "Vous hÃ©ritez d'un vieux chÃ¢teau en Provence. La premiÃ¨re nuit, vous entendez des bruits Ã©tranges provenant du sous-sol. Que faites-vous ?": 
                    "æ‚¨ç»§æ‰¿äº†æ™®ç½—æ—ºæ–¯çš„ä¸€åº§å¤è€åŸå ¡ã€‚ç¬¬ä¸€æ™šï¼Œæ‚¨å¬åˆ°ä»åœ°ä¸‹å®¤ä¼ æ¥å¥‡æ€ªçš„å£°éŸ³ã€‚æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ"
                }
            };
            
            return translations[theme] && translations[theme][content] ? translations[theme][content] : "ç¿»è¯‘æš‚ä¸å¯ç”¨";
        }
        
        // è·å–é€‰é¡¹ç¿»è¯‘
        function getChoiceTranslation(choice, theme) {
            const translations = {
                'sci-fi': {
                    "Je vais Ã  la salle des machines pour inspecter le problÃ¨me.": "æˆ‘å»æœºå™¨å®¤æ£€æŸ¥é—®é¢˜ã€‚",
                    "Je reste sur le pont et j'essaie de comprendre les donnÃ©es sur l'Ã©cran.": "æˆ‘ç•™åœ¨ç”²æ¿ä¸Šï¼Œè¯•ç€ç†è§£å±å¹•ä¸Šçš„æ•°æ®ã€‚",
                    "J'inspecte le gÃ©nÃ©rateur de plus prÃ¨s.": "æˆ‘ä»”ç»†æ£€æŸ¥å‘ç”µæœºã€‚",
                    "Je retourne sur le pont pour demander de l'aide.": "æˆ‘å›åˆ°ç”²æ¿å¯»æ±‚å¸®åŠ©ã€‚",
                    "J'essaie de corriger le cap manuellement.": "æˆ‘å°è¯•æ‰‹åŠ¨ä¿®æ­£èˆªå‘ã€‚",
                    "Je vÃ©rifie si quelqu'un a accÃ©dÃ© au systÃ¨me de navigation.": "æˆ‘æ£€æŸ¥æ˜¯å¦æœ‰äººè®¿é—®äº†å¯¼èˆªç³»ç»Ÿã€‚"
                },
                'romance': {
                    "Je lui demande de poser pour mon tableau.": "æˆ‘è¯·å¥¹ä¸ºæˆ‘çš„ç”»ä½œå½“æ¨¡ç‰¹ã€‚",
                    "Je l'invite Ã  prendre un cafÃ© dans un petit cafÃ© parisien.": "æˆ‘é‚€è¯·å¥¹å»ä¸€å®¶å·´é»å°å’–å•¡é¦†å–å’–å•¡ã€‚",
                    "Je lui demande de jouer du piano pour vous.": "æˆ‘è¯·å¥¹ä¸ºæ‚¨å¼¹é’¢ç´ã€‚",
                    "Je lui parle de votre passion pour l'art.": "æˆ‘å‘å¥¹è®²è¿°æ‚¨å¯¹è‰ºæœ¯çš„çƒ­çˆ±ã€‚",
                    "Je lui offre le tableau que vous Ãªtes en train de peindre.": "æˆ‘æŠŠæˆ‘æ­£åœ¨ç”»çš„ç”»é€ç»™å¥¹ã€‚",
                    "Je lui demande si elle veut apprendre Ã  peindre.": "æˆ‘é—®å¥¹æ˜¯å¦æƒ³å­¦ç”»ç”»ã€‚"
                },
                'thriller': {
                    "J'explore le sous-sol avec une lampe torche.": "æˆ‘å¸¦ç€æ‰‹ç”µç­’æ¢ç´¢åœ°ä¸‹å®¤ã€‚",
                    "J'appelle la police pour signaler les bruits suspects.": "æˆ‘æ‰“ç”µè¯ç»™è­¦å¯ŸæŠ¥å‘Šå¯ç–‘çš„å£°éŸ³ã€‚",
                    "J'essaie de forcer la porte.": "æˆ‘è¯•å›¾å¼ºè¡Œæ‰“å¼€é—¨ã€‚",
                    "Je cherche la clÃ© dans le chÃ¢teau.": "æˆ‘åœ¨åŸå ¡é‡Œå¯»æ‰¾é’¥åŒ™ã€‚",
                    "Je lis le journal pour en savoir plus sur l'histoire du chÃ¢teau.": "æˆ‘é˜…è¯»æ—¥è®°ä»¥äº†è§£åŸå ¡çš„å†å²ã€‚",
                    "Je continue Ã  explorer en attendant la police.": "æˆ‘ç»§ç»­æ¢ç´¢ï¼Œç­‰å¾…è­¦å¯Ÿåˆ°æ¥ã€‚"
                }
            };
            
            return translations[theme] && translations[theme][choice] ? translations[theme][choice] : "ç¿»è¯‘æš‚ä¸å¯ç”¨";
        }
        
        // å•è¯ç‚¹å‡»åŠŸèƒ½ - ä¿®å¤ç‰ˆï¼šåªé«˜äº®é‡ç‚¹è¯æ±‡
        function setupWordClickEvents() {
            // ä¸ºæ‰€æœ‰æ³•è¯­æ–‡æœ¬æ·»åŠ ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.french-text').forEach(element => {
                // å…ˆæ¸…é™¤ä¹‹å‰çš„å†…å®¹
                element.innerHTML = element.textContent;
                
                // å°†æ–‡æœ¬åˆ†å‰²æˆå•è¯
                const text = element.textContent;
                const words = text.split(/(\s+)/);
                
                // é‡æ–°æ„å»ºHTMLï¼Œä¸ºæ¯ä¸ªå•è¯æ·»åŠ spanåŒ…è£…
                element.innerHTML = words.map(word => {
                    if (word.trim() === '') return word;
                    
                    // æ¸…ç†å•è¯ï¼ˆç§»é™¤æ ‡ç‚¹ï¼‰
                    const cleanWord = word.toLowerCase().replace(/[.,!?;:"]/g, '');
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨é‡ç‚¹è¯æ±‡åˆ—è¡¨ä¸­
                    if (highlightedWords.includes(cleanWord)) {
                        return `<span class="word-highlight" data-word="${cleanWord}">${word}</span>`;
                    } else {
                        return `<span class="word-clickable" data-word="${cleanWord}">${word}</span>`;
                    }
                }).join('');
                
                // ä¸ºæ‰€æœ‰å•è¯æ·»åŠ ç‚¹å‡»äº‹ä»¶
                element.querySelectorAll('span[data-word]').forEach(span => {
                    span.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const word = span.getAttribute('data-word');
                        
                        if (frenchDictionary[word]) {
                            const wordData = frenchDictionary[word];
                            showWordTooltip(
                                word, 
                                wordData.definition, 
                                wordData.pronunciation, 
                                wordData.pos, 
                                e.pageX, 
                                e.pageY
                            );
                        } else {
                            // å¦‚æœå•è¯ä¸åœ¨è¯å…¸ä¸­ï¼Œæ˜¾ç¤ºæç¤º
                            showWordTooltip(
                                word, 
                                "æœªæ‰¾åˆ°é‡Šä¹‰", 
                                "", 
                                "", 
                                e.pageX, 
                                e.pageY
                            );
                        }
                    });
                });
            });
        }
        
        function showWordTooltip(word, definition, pronunciation, pos, x, y) {
            const tooltip = document.getElementById('word-tooltip');
            
            document.getElementById('tooltip-word').textContent = word;
            document.getElementById('tooltip-pos').textContent = pos;
            document.getElementById('tooltip-definition').textContent = definition;
            document.getElementById('pronunciation-text').textContent = pronunciation;
            
            // å®šä½å·¥å…·æç¤º - ç¡®ä¿æ˜¾ç¤ºåœ¨å•è¯é™„è¿‘
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let left = x;
            let top = y + 20;
            
            // ç¡®ä¿å·¥å…·æç¤ºä¸ä¼šè¶…å‡ºè§†å£
            if (left + 300 > viewportWidth) {
                left = viewportWidth - 320;
            }
            
            if (top + 150 > viewportHeight) {
                top = y - 160;
            }
            
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
            tooltip.style.display = 'block';
            
            // è®¾ç½®æ·»åŠ åˆ°ç”Ÿè¯æœ¬æŒ‰é’®çš„æ•°æ®
            document.getElementById('add-to-vocab-btn').setAttribute('data-word', word);
            document.getElementById('add-to-vocab-btn').setAttribute('data-definition', definition);
            document.getElementById('add-to-vocab-btn').setAttribute('data-pronunciation', pronunciation);
            document.getElementById('add-to-vocab-btn').setAttribute('data-pos', pos);
            
            // æ’­æ”¾å•è¯å‘éŸ³
            speakWord(word);
        }
        
        // å‘éŸ³åŠŸèƒ½
        function speakWord(word) {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ
            if (!('speechSynthesis' in window)) {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½ï¼Œè¯·å°è¯•ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ã€‚");
                return;
            }
            
            const utterance = new SpeechSynthesisUtterance(word);
            utterance.lang = 'fr-FR';
            utterance.rate = 0.8;
            
            window.speechSynthesis.speak(utterance);
        }
        
        // å…¨æ–‡æœ—è¯»åŠŸèƒ½
        function playStoryAudio(text, lang = 'fr-FR') {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ
            if (!('speechSynthesis' in window)) {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½ï¼Œè¯·å°è¯•ä½¿ç”¨Chromeæˆ–Edgeæµè§ˆå™¨ã€‚");
                return;
            }
            
            // åœæ­¢å½“å‰æ’­æ”¾
            if (isPlaying && currentUtterance) {
                window.speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.8;
            
            // æ˜¾ç¤ºæ’­æ”¾çŠ¶æ€
            document.getElementById('audio-playing-indicator').style.display = 'flex';
            document.getElementById('replay-text').style.display = 'none';
            isPlaying = true;
            currentUtterance = utterance;
            
            utterance.onend = function() {
                // æ’­æ”¾ç»“æŸï¼Œæ˜¾ç¤ºé‡æ–°æ’­æ”¾æŒ‰é’®
                document.getElementById('audio-playing-indicator').style.display = 'none';
                document.getElementById('replay-text').style.display = 'inline';
                document.getElementById('replay-text').textContent = 'ğŸ”Š é‡æ–°æ’­æ”¾';
                isPlaying = false;
                currentUtterance = null;
            };
            
            utterance.onerror = function() {
                // æ’­æ”¾å‡ºé”™ï¼Œæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
                document.getElementById('audio-playing-indicator').style.display = 'none';
                document.getElementById('replay-text').style.display = 'inline';
                document.getElementById('replay-text').textContent = 'ğŸ”Š æ’­æ”¾éŸ³é¢‘';
                isPlaying = false;
                currentUtterance = null;
            };
            
            window.speechSynthesis.speak(utterance);
        }
        
        // æ•…äº‹æ’­æ”¾æŒ‰é’®
        document.getElementById('story-play-toggle-btn').addEventListener('click', () => {
            const storyText = document.getElementById('story-text').textContent;
            playStoryAudio(storyText);
        });
        
        // é€‰é¡¹ç¿»è¯‘æŒ‰é’® - ä¿®å¤ç‰ˆï¼šé˜»æ­¢äº‹ä»¶å†’æ³¡
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('translation-btn')) {
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
                const translation = e.target.parentElement.querySelector('.choice-translation');
                if (translation) {
                    translation.style.display = translation.style.display === 'none' ? 'block' : 'none';
                }
                return false; // è¿›ä¸€æ­¥é˜»æ­¢äº‹ä»¶
            }
        });
        
        // ç‚¹å‡»é¡µé¢å…¶ä»–ä½ç½®æ—¶éšè—å•è¯å·¥å…·æç¤º
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.word-tooltip') && !e.target.classList.contains('word-highlight') && !e.target.classList.contains('word-clickable')) {
                document.getElementById('word-tooltip').style.display = 'none';
            }
        });
        
        // æ˜¾ç¤ºç¿»è¯‘åŠŸèƒ½ - ä¿®å¤ç‰ˆï¼šä¸€æ¬¡ç‚¹å‡»æ˜¾ç¤º
        document.getElementById('show-translation-btn').addEventListener('click', () => {
            const translation = document.getElementById('story-translation');
            translation.style.display = translation.style.display === 'none' ? 'block' : 'none';
        });
        
        // æ·»åŠ åˆ°ç”Ÿè¯æœ¬åŠŸèƒ½
        document.getElementById('add-to-vocab-btn').addEventListener('click', (e) => {
            const word = e.target.getAttribute('data-word');
            const definition = e.target.getAttribute('data-definition');
            const pronunciation = e.target.getAttribute('data-pronunciation');
            const pos = e.target.getAttribute('data-pos');
            
            // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨
            const exists = vocabBook.some(item => item.word === word);
            if (!exists) {
                vocabBook.push({ word, definition, pronunciation, pos });
                localStorage.setItem('vocabBook', JSON.stringify(vocabBook));
                alert(`"${word}" å·²æ·»åŠ åˆ°ç”Ÿè¯æœ¬ï¼`);
            } else {
                alert(`"${word}" å·²ç»åœ¨ç”Ÿè¯æœ¬ä¸­ï¼`);
            }
            
            // éšè—å·¥å…·æç¤º
            document.getElementById('word-tooltip').style.display = 'none';
        });
        
        // æ›´æ–°ç”Ÿè¯æœ¬æ˜¾ç¤º
        function updateVocabBookDisplay() {
            const vocabBookList = document.getElementById('vocab-book-list');
            vocabBookList.innerHTML = '';
            
            if (vocabBook.length === 0) {
                vocabBookList.innerHTML = '<div class="vocab-item"><div>ç”Ÿè¯æœ¬ä¸ºç©ºï¼Œè¯·åœ¨é˜…è¯»è¿‡ç¨‹ä¸­æ·»åŠ å•è¯ã€‚</div></div>';
                return;
            }
            
            vocabBook.forEach((item, index) => {
                const vocabItem = document.createElement('div');
                vocabItem.className = 'vocab-item';
                vocabItem.innerHTML = `
                    <div>
                        <div class="vocab-word">${item.word} <span style="font-style: italic; color: #666; font-size: 0.9rem;">(${item.pos})</span></div>
                        <div class="vocab-definition">${item.definition}</div>
                    </div>
                    <div>
                        <button class="audio-btn play-vocab-audio" data-word="${item.word}">ğŸ”Š</button>
                        <button class="btn btn-secondary remove-vocab" data-index="${index}">ç§»é™¤</button>
                    </div>
                `;
                vocabBookList.appendChild(vocabItem);
            });
            
            // æ·»åŠ ç§»é™¤äº‹ä»¶
            document.querySelectorAll('.remove-vocab').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    vocabBook.splice(index, 1);
                    localStorage.setItem('vocabBook', JSON.stringify(vocabBook));
                    updateVocabBookDisplay();
                });
            });
            
            // æ·»åŠ ç”Ÿè¯æœ¬éŸ³é¢‘æ’­æ”¾äº‹ä»¶
            document.querySelectorAll('.play-vocab-audio').forEach(btn => {
                btn.addEventListener('click', function() {
                    const word = this.getAttribute('data-word');
                    speakWord(word);
                });
            });
        }
        
        // æ¸…ç©ºç”Ÿè¯æœ¬
        document.getElementById('clear-vocab').addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºç”Ÿè¯æœ¬å—ï¼Ÿ')) {
                vocabBook = [];
                localStorage.setItem('vocabBook', JSON.stringify(vocabBook));
                updateVocabBookDisplay();
            }
        });
        
        // æ•…äº‹é€‰æ‹©åŠŸèƒ½
        function attachChoiceEvents() {
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯ç¿»è¯‘æŒ‰é’®ï¼Œä¸å¤„ç†é€‰æ‹©
                    if (e.target.classList.contains('translation-btn') || e.target.classList.contains('choice-translation')) {
                        return;
                    }
                    
                    const nextStep = btn.getAttribute('data-next');
                    
                    // ä¿å­˜å½“å‰çŠ¶æ€åˆ°å†å²
                    storyHistory.push({
                        theme: currentTheme,
                        step: parseInt(nextStep),
                        title: document.getElementById('story-title').textContent,
                        content: document.getElementById('story-text').textContent,
                        image: document.getElementById('story-image').src,
                        choices: Array.from(document.querySelectorAll('.choice-btn')).map(b => b.innerHTML)
                    });
                    
                    // æ ¹æ®é€‰æ‹©æ›´æ–°æ•…äº‹
                    handleStoryChoice(nextStep);
                });
            });
        }
        
        // å¤„ç†æ•…äº‹é€‰æ‹©
        function handleStoryChoice(step) {
            let storyContent, storyTranslation, choices, storyImage;
            
            currentPage = parseInt(step);
            
            switch(step) {
                case '1':
                    if (currentTheme === 'sci-fi') {
                        storyContent = "Vous arrivez dans la salle des machines. C'est sombre et vous entendez un bruit Ã©trange provenant du gÃ©nÃ©rateur principal. Que faites-vous ?";
                        storyTranslation = "æ‚¨åˆ°è¾¾äº†æœºå™¨å®¤ã€‚é‡Œé¢å¾ˆæš—ï¼Œæ‚¨å¬åˆ°ä»ä¸»å‘ç”µæœºä¼ æ¥å¥‡æ€ªçš„å£°éŸ³ã€‚æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ";
                        choices = [
                            "J'inspecte le gÃ©nÃ©rateur de plus prÃ¨s.",
                            "Je retourne sur le pont pour demander de l'aide."
                        ];
                        storyImage = "https://images.unsplash.com/photo-1535378620166-273708d44e4c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    } else if (currentTheme === 'romance') {
                        storyContent = "La personne accepte votre invitation. Au cafÃ©, vous apprenez qu'elle s'appelle Sophie et qu'elle est musicienne. Que faites-vous ?";
                        storyTranslation = "å¯¹æ–¹æ¥å—äº†æ‚¨çš„é‚€è¯·ã€‚åœ¨å’–å•¡é¦†ï¼Œæ‚¨å¾—çŸ¥å¥¹å«ç´¢è²ï¼Œæ˜¯ä¸€ä½éŸ³ä¹å®¶ã€‚æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ";
                        choices = [
                            "Je lui demande de jouer du piano pour vous.",
                            "Je lui parle de votre passion pour l'art."
                        ];
                        storyImage = "https://images.unsplash.com/photo-1445019980597-93fa8acb246c?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    } else if (currentTheme === 'thriller') {
                        storyContent = "Dans le sous-sol, vous trouvez une vieille porte verrouillÃ©e. Des bruits Ã©tranges semblent venir de derriÃ¨re. Que faites-vous ?";
                        storyTranslation = "åœ¨åœ°ä¸‹å®¤ï¼Œæ‚¨å‘ç°äº†ä¸€æ‰‡é”ç€çš„æ—§é—¨ã€‚å¥‡æ€ªçš„å£°éŸ³ä¼¼ä¹æ¥è‡ªé—¨åã€‚æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ";
                        choices = [
                            "J'essaie de forcer la porte.",
                            "Je cherche la clÃ© dans le chÃ¢teau."
                        ];
                        storyImage = "https://images.unsplash.com/photo-1578683010236-d716f9a3f461?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    }
                    break;
                case '2':
                    if (currentTheme === 'sci-fi') {
                        storyContent = "Vous restez sur le pont et analysez les donnÃ©es. Vous remarquez une anomalie dans le systÃ¨me de navigation. Il semble que le vaisseau ait changÃ© de cap sans autorisation. Que faites-vous ?";
                        storyTranslation = "æ‚¨ç•™åœ¨ç”²æ¿ä¸Šåˆ†ææ•°æ®ã€‚æ‚¨æ³¨æ„åˆ°å¯¼èˆªç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªå¼‚å¸¸ã€‚ä¼¼ä¹é£èˆ¹åœ¨æœªç»æˆæƒçš„æƒ…å†µä¸‹æ”¹å˜äº†èˆªå‘ã€‚æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ";
                        choices = [
                            "J'essaie de corriger le cap manuellement.",
                            "Je vÃ©rifie si quelqu'un a accÃ©dÃ© au systÃ¨me de navigation."
                        ];
                        storyImage = "https://images.unsplash.com/photo-1502136969935-8d8eef54d77b?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    } else if (currentTheme === 'romance') {
                        storyContent = "Vous dÃ©cidez de rester Ã  peindre. Sophie revient le lendemain et vous regarde travailler. Que faites-vous ?";
                        storyTranslation = "æ‚¨å†³å®šç»§ç»­ç”»ç”»ã€‚ç´¢è²ç¬¬äºŒå¤©åˆæ¥äº†ï¼Œçœ‹ç€æ‚¨å·¥ä½œã€‚æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ";
                        choices = [
                            "Je lui offre le tableau que vous Ãªtes en train de peindre.",
                            "Je lui demande si elle veut apprendre Ã  peindre."
                        ];
                        storyImage = "https://images.unsplash.com/photo-1513475382585-d06e58bcb0e0?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    } else if (currentTheme === 'thriller') {
                        storyContent = "Vous dÃ©cidez d'appeler la police. En attendant, vous explorez le rez-de-chaussÃ©e et trouvez un vieux journal. Que faites-vous ?";
                        storyTranslation = "æ‚¨å†³å®šæ‰“ç”µè¯ç»™è­¦å¯Ÿã€‚ç­‰å¾…æœŸé—´ï¼Œæ‚¨æ¢ç´¢äº†ä¸€æ¥¼ï¼Œå‘ç°äº†ä¸€æœ¬æ—§æ—¥è®°ã€‚æ‚¨ä¼šæ€ä¹ˆåšï¼Ÿ";
                        choices = [
                            "Je lis le journal pour en savoir plus sur l'histoire du chÃ¢teau.",
                            "Je continue Ã  explorer en attendant la police."
                        ];
                        storyImage = "https://images.unsplash.com/photo-1578683010236-d716f9a3f461?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    }
                    break;
                case '3':
                case '4':
                    // ç¬¬ä¸‰é¡µæ•…äº‹å†…å®¹
                    if (currentTheme === 'sci-fi') {
                        storyContent = "Vous avez rÃ©solu le problÃ¨me! Le vaisseau est maintenant en sÃ©curitÃ©. FÃ©licitations!";
                        storyTranslation = "æ‚¨è§£å†³äº†é—®é¢˜ï¼é£èˆ¹ç°åœ¨å®‰å…¨äº†ã€‚æ­å–œï¼";
                        choices = [];
                        storyImage = "https://images.unsplash.com/photo-1462331940025-496dfbfc7564?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    } else if (currentTheme === 'romance') {
                        storyContent = "Votre relation avec Sophie se dÃ©veloppe. Vous passez de merveilleux moments ensemble Ã  Paris.";
                        storyTranslation = "æ‚¨ä¸ç´¢è²çš„å…³ç³»ä¸æ–­å‘å±•ã€‚ä½ ä»¬åœ¨å·´é»ä¸€èµ·åº¦è¿‡äº†ç¾å¥½çš„æ—¶å…‰ã€‚";
                        choices = [];
                        storyImage = "https://images.unsplash.com/photo-1431274172761-fca41d930114?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    } else if (currentTheme === 'thriller') {
                        storyContent = "Vous avez dÃ©couvert le secret du chÃ¢teau! Maintenant, vous devez dÃ©cider quoi faire de cette dÃ©couverte.";
                        storyTranslation = "æ‚¨å‘ç°äº†åŸå ¡çš„ç§˜å¯†ï¼ç°åœ¨ï¼Œæ‚¨å¿…é¡»å†³å®šå¦‚ä½•å¤„ç†è¿™ä¸ªå‘ç°ã€‚";
                        choices = [];
                        storyImage = "https://images.unsplash.com/photo-1578683010236-d716f9a3f461?ixlib=rb-1.2.1&auto=format&fit=crop&w=1200&q=80";
                    }
                    break;
            }
            
            document.getElementById('story-text').textContent = storyContent;
            document.getElementById('story-translation').innerHTML = `<strong>ä¸­æ–‡ç¿»è¯‘ï¼š</strong><br>${storyTranslation}`;
            document.getElementById('story-translation').style.display = 'none'; // é‡ç½®ç¿»è¯‘æ˜¾ç¤ºçŠ¶æ€
            document.getElementById('story-image').src = storyImage;
            
            // æ›´æ–°é€‰é¡¹
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = '';
            
            if (choices.length > 0) {
                choices.forEach((choice, index) => {
                    const choiceBtn = document.createElement('div');
                    choiceBtn.className = 'choice-btn';
                    choiceBtn.setAttribute('data-next', index + 3); // 3å’Œ4å¯¹åº”ç¬¬ä¸‰é¡µ
                    choiceBtn.innerHTML = `
                        ${choice}
                        <button class="translation-btn">ç¿»è¯‘</button>
                        <div class="choice-translation" style="display: none;">${getChoiceTranslation(choice, currentTheme)}</div>
                    `;
                    choicesContainer.appendChild(choiceBtn);
                });
                
                // éšè—å®ŒæˆæŒ‰é’®
                document.getElementById('complete-story-btn').style.display = 'none';
            } else {
                choicesContainer.innerHTML = '<p>æ•…äº‹ç»“æŸï¼æ„Ÿè°¢æ‚¨çš„å‚ä¸ã€‚</p>';
                // æ˜¾ç¤ºå®ŒæˆæŒ‰é’®
                document.getElementById('complete-story-btn').style.display = 'block';
            }
            
            // æ›´æ–°è¿›åº¦ - ä¿®å¤ç‰ˆï¼šæ­£ç¡®çš„è¿›åº¦è®¡ç®—
            // ç¬¬ä¸€é¡µ: 0%, ç¬¬äºŒé¡µ: 33%, ç¬¬ä¸‰é¡µ: 66% (ç‚¹å‡»å®ŒæˆæŒ‰é’®å100%)
            if (currentPage === 1) {
                updateStoryProgress(33); // ç¬¬äºŒé¡µæ˜¾ç¤º33%
            } else if (currentPage >= 2) {
                updateStoryProgress(66); // ç¬¬ä¸‰é¡µæ˜¾ç¤º66%
            }
            
            // é‡æ–°é™„åŠ äº‹ä»¶åˆ°æ–°æŒ‰é’®
            attachChoiceEvents();
            setupWordClickEvents();
            
            // ä¸è‡ªåŠ¨æ’­æ”¾ï¼Œåªæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
            document.getElementById('audio-playing-indicator').style.display = 'none';
            document.getElementById('replay-text').style.display = 'inline';
            document.getElementById('replay-text').textContent = 'ğŸ”Š æ’­æ”¾éŸ³é¢‘';
        }
        
        // æ›´æ–°æ•…äº‹è¿›åº¦
        function updateStoryProgress(percent) {
            document.getElementById('story-progress').style.width = `${percent}%`;
            document.getElementById('story-progress-text').textContent = `${percent}%`;
        }
        
        // å®Œæˆæ•…äº‹æŒ‰é’®
        document.getElementById('complete-story-btn').addEventListener('click', () => {
            updateStoryProgress(100);
            alert("æ­å–œæ‚¨å®Œæˆæ•…äº‹ï¼");
        });
        
        // æ•…äº‹é¡µé¢ä¸Šä¸€é¡µæŒ‰é’®
        document.getElementById('prev-story-btn').addEventListener('click', () => {
            if (storyHistory.length > 1) {
                // ç§»é™¤å½“å‰çŠ¶æ€
                storyHistory.pop();
                // è·å–ä¸Šä¸€ä¸ªçŠ¶æ€
                const prevState = storyHistory[storyHistory.length - 1];
                
                // æ¢å¤çŠ¶æ€
                document.getElementById('story-title').textContent = prevState.title;
                document.getElementById('story-text').textContent = prevState.content;
                document.getElementById('story-image').src = prevState.image;
                
                // æ›´æ–°é€‰é¡¹
                const choicesContainer = document.getElementById('choices-container');
                choicesContainer.innerHTML = '';
                
                prevState.choices.forEach((choice, index) => {
                    const choiceBtn = document.createElement('div');
                    choiceBtn.className = 'choice-btn';
                    choiceBtn.setAttribute('data-next', index + 1);
                    choiceBtn.innerHTML = choice + '<button class="translation-btn">ç¿»è¯‘</button><div class="choice-translation" style="display: none;">' + getChoiceTranslation(choice, currentTheme) + '</div>';
                    choicesContainer.appendChild(choiceBtn);
                });
                
                // æ›´æ–°è¿›åº¦
                currentPage = prevState.step;
                if (currentPage === 0) {
                    updateStoryProgress(0);
                } else if (currentPage === 1) {
                    updateStoryProgress(33);
                }
                
                // éšè—å®ŒæˆæŒ‰é’®
                document.getElementById('complete-story-btn').style.display = 'none';
                
                // é‡æ–°é™„åŠ äº‹ä»¶
                attachChoiceEvents();
                setupWordClickEvents();
                
                // ä¸è‡ªåŠ¨æ’­æ”¾ï¼Œåªæ˜¾ç¤ºæ’­æ”¾æŒ‰é’®
                document.getElementById('audio-playing-indicator').style.display = 'none';
                document.getElementById('replay-text').style.display = 'inline';
                document.getElementById('replay-text').textContent = 'ğŸ”Š æ’­æ”¾éŸ³é¢‘';
            } else {
                alert("å·²ç»æ˜¯ç¬¬ä¸€é¡µäº†ï¼");
            }
        });
        
        // é‡æ–°å¼€å§‹æŒ‰é’®
        document.getElementById('restart-btn').addEventListener('click', () => {
            // åˆ‡æ¢åˆ°ä¸»é¢˜é€‰æ‹©é¡µé¢
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelector('.tab[data-tab="theme"]').classList.add('active');
            document.getElementById('theme-section').classList.add('active');
            
            // é‡ç½®æ•…äº‹å†å²
            storyHistory = [];
            currentPage = 0;
        });
        
        // ä¿å­˜æŒ‰é’®
        document.getElementById('save-btn').addEventListener('click', () => {
            alert("æ‚¨çš„è¿›åº¦å·²ä¿å­˜ï¼");
        });
        
        // åˆå§‹åŒ–
        setupWordClickEvents();
        updateStoryProgress(0);
        updateVocabBookDisplay();
        attachChoiceEvents();
    </script>
</body>
</html>